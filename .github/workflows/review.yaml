name: Review Changes

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  checks: write
  contents: read
  issues: write
  pull-requests: write

jobs:
  lint-code:
    name: Lint Source Code
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main
        with:
          node-version-file: .node-version

      - name: ğŸ” Find problems in source code
        id: lint-code
        run: |
          if [ "${{ github.event.pull_request.head.repo.full_name }}" == "${{ github.repository }}" ]; then
            pnpm -s run lint:code --format=json --output-file=eslint-report.json
          else
            echo "The pull request comes from a forked repository, skipping annotations, lint report and pull request comment."
            pnpm -s run lint:code
          fi

      - name: ğŸš€ Update annotations and create lint report
        if: ${{ !cancelled() && (steps.lint-code.outcome == 'success' || steps.lint-code.outcome == 'failure') && github.event.pull_request.head.repo.full_name == github.repository }}
        id: lint-report
        uses: ataylorme/eslint-annotate-action@v3
        with:
          report-json: eslint-report.json

      - name: ğŸ“ Add pull request comment
        if: ${{ !cancelled() && steps.lint-report.outcome == 'success' && github.event.pull_request.head.repo.full_name == github.repository }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: lint-report
          message: ${{ steps.lint-report.outputs.summary }}

  lint-commits:
    name: Lint Commit Message Format
    if: ${{ github.actor != 'dependabot[bot]' && github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main
        with:
          node-version-file: .node-version

      - name: ğŸ” Lint all commit messages
        run: |
          pnpm -s run lint:commits \
            --from ${{ github.event.pull_request.head.sha }}~${{ github.event.pull_request.commits }} \
            --to ${{ github.event.pull_request.head.sha }}

  lint-deps:
    name: Lint Dependencies, Files and Exports
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main
        with:
          node-version-file: .node-version

      - name: ğŸ” Find unused files, dependencies and exports
        run: pnpm -s run lint:deps --reporter github-actions

  lint-markdown:
    name: Lint Markdown Files
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main
        with:
          node-version-file: .node-version

      - name: ğŸ” Lint all Markdown files
        run: pnpm -s run lint:markdown

  lint-style:
    name: Lint File Format
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main
        with:
          node-version-file: .node-version

      - name: ğŸ” Check if the files are formatted
        run: pnpm -s run lint:style

  lint-versions:
    name: Lint Consistency of Versions and Ranges
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main
        with:
          node-version-file: .node-version

      - name: ğŸ” Lint all versions and ranges
        run: pnpm -s run lint:versions

  validate-and-build:
    name: Validate and Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: ğŸ— Setup Turborepo
        uses: skriptfabrik/github-actions/setup-turborepo@main
        with:
          node-version-file: .node-version
          turbo-s3-endpoint: nbg1.your-objectstorage.com
          turbo-s3-region: nbg1
          turbo-s3-bucket: turbo-bucket-1
          turbo-s3-access-key: ${{ secrets.TURBO_S3_ACCESS_KEY }}
          turbo-s3-secret-key: ${{ secrets.TURBO_S3_SECRET_KEY }}
          turbo-token: ${{ secrets.TURBO_TOKEN }}

      - name: ğŸ”¨ Run build of packages affected by changes
        run: pnpm -s run build --affected

      - name: ğŸ” Validate packages affected by changes against requirements
        run: pnpm -s run validate --affected
